name: Deploy to VM

on:
  push:
    branches: [ main ]

env:
  VM_HOST: 192.168.42.129
  VM_USER: my

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        cat >> ~/.ssh/config << EOF
        Host ${{ env.VM_HOST }}
          HostName ${{ env.VM_HOST }}
          User ${{ env.VM_USER }}
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
    
    - name: Deploy application
      run: |
        ssh ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          set -e
          
          cd ~/ai-web-app
          echo '=== Pulling latest code ==='
          git pull origin main
          
          echo '=== Building and starting containers ==='
          sudo docker compose down
          sudo docker compose build --no-cache
          sudo docker compose up -d
          
          echo '=== Waiting for services to start ==='
          sleep 10
          
          echo '=== Checking container health ==='
          sudo docker compose ps
          curl -f http://localhost:5000 > /dev/null 2>&1 && echo 'Frontend is up' || echo 'Frontend check failed'
          curl -f http://localhost:8000 > /dev/null 2>&1 && echo 'Backend is up' || echo 'Backend check failed'
          
          echo '=== Ensuring systemd service is running ==='
          sudo systemctl daemon-reload
          sudo systemctl is-active ai-web-app.service || sudo systemctl start ai-web-app.service
          
          echo '=== Deployment successful ==='
        "
