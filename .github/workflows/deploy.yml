name: Deploy AI App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Check Docker and Docker Compose
      run: |
        docker --version
        docker-compose --version
        docker compose version || echo "docker compose not available"
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Copy application code
      run: |
        mkdir -p /opt/ai-app
        cp -r $GITHUB_WORKSPACE/* /opt/ai-app/ || true
        
    - name: Deploy application
      run: |
        set -e
        echo 'Starting deployment...'
        cd /opt/ai-app
        
        echo '=== Stopping existing containers ==='
        docker-compose down || true
        
        echo '=== Building containers ==='
        #docker-compose build --no-cache
        docker-compose build --pull
        
        echo '=== Starting services ==='
        docker-compose up -d
        
        echo '=== Waiting for services to be healthy ==='
        sleep 30
        
        echo '=== Health checks ==='
        curl -f http://localhost:8000/health && echo 'Backend healthy'
        curl -f http://localhost:5000/health && echo 'Frontend healthy'
        
        echo 'Nice, Deployment completed successfully!'
